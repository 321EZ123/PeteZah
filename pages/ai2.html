<html lang="en"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>OmniChat - Into the Unknown</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/smoressy/tab-changer-9000/refs/heads/main/image-removebg-preview%20(5).png">
  <style type="text/css">@font-face {font-family:Poppins;font-style:normal;font-weight:400;src:url(/cf-fonts/s/poppins/5.0.11/devanagari/400/normal.woff2);unicode-range:U+0900-097F,U+1CD0-1CF9,U+200C-200D,U+20A8,U+20B9,U+25CC,U+A830-A839,U+A8E0-A8FF;font-display:swap;}@font-face {font-family:Poppins;font-style:normal;font-weight:400;src:url(/cf-fonts/s/poppins/5.0.11/latin/400/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}@font-face {font-family:Poppins;font-style:normal;font-weight:400;src:url(/cf-fonts/s/poppins/5.0.11/latin-ext/400/normal.woff2);unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;font-display:swap;}@font-face {font-family:Poppins;font-style:normal;font-weight:600;src:url(/cf-fonts/s/poppins/5.0.11/latin/600/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}@font-face {font-family:Poppins;font-style:normal;font-weight:600;src:url(/cf-fonts/s/poppins/5.0.11/devanagari/600/normal.woff2);unicode-range:U+0900-097F,U+1CD0-1CF9,U+200C-200D,U+20A8,U+20B9,U+25CC,U+A830-A839,U+A8E0-A8FF;font-display:swap;}@font-face {font-family:Poppins;font-style:normal;font-weight:600;src:url(/cf-fonts/s/poppins/5.0.11/latin-ext/600/normal.woff2);unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;font-display:swap;}</style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
  <style>
    /* Universal Bold Poppins */
    * {
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: #000;
      color: #fff;
    }
    #main-container {
      display: flex;
      height: 100%;
      overflow: hidden;
    }
    #sidebar {
      width: 250px;
      flex-shrink: 0;
      background-color: #111;
      border-right: 1px solid #222;
      display: flex;
      flex-direction: column;
    }
    #brand-name {
      font-size: 24px;
      text-align: center;
      margin: 15px 0;
    }
    #new-chat-button, #upgrade-sidebar-btn {
      background: #212121;
      border: none;
      color: #fff;
      padding: 10px;
      border-radius: 10px;
      margin: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    #new-chat-button i, #upgrade-sidebar-btn i {
      margin-right: 5px;
    }
    #chat-list {
      flex-grow: 1;
      overflow-y: auto;
      padding: 10px;
    }
    .chat-item {
      padding: 8px;
      margin-bottom: 5px;
      background: #1a1a1a;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
    }
    #chat-area {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: #111;
      border-bottom: 1px solid #222;
    }
    #message-caps-info {
      font-size: 14px;
    }
    #auth-buttons button, #settings-btn {
      background: #1a1a1a;
      border: none;
      color: #fff;
      padding: 6px 12px;
      margin-left: 10px;
      border-radius: 16px;
      cursor: pointer;
    }
    #settings-btn {
      display: none;
      border-radius: 10px;
    }
    #chat-container {
      display: flex;
      flex-direction: column;
      flex-grow: 1;
      overflow: hidden;
    }
    #chat-display {
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .message {
      margin-bottom: 10px;
      padding: 10px 15px;
      border-radius: 20px;
      max-width: 80%;
      word-wrap: break-word;
      transition: opacity 0.3s ease-in-out;
      font-size: 15px;
    }
    .user-message {
      background: #1a1a1a;
      align-self: flex-end;
    }
    .ai-message {
      background: #101010;
      align-self: flex-start;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3), 0 1px 2px rgba(0,0,0,0.5);
      opacity: 0;
    }
    .ai-message p {
      margin: 0;
      font-size: 15px;
    }
    .ai-message a {
      color: #4fc3f7;
    }
    #input-area {
      padding: 15px;
      border-top: 1px solid #444;
      display: flex;
      align-items: center;
      background: #111;
      box-shadow: 0 -1px 3px rgba(0,0,0,0.3), 0 -1px 2px rgba(0,0,0,0.5);
      flex-direction: column;
    }
    #control-row {
      width: 100%;
      display: flex;
      align-items: center;
    }
    #folder-icon {
      font-size: 18px;
      margin-right: 10px;
      cursor: pointer;
      border-radius: 50%;
      transition: background-color 0.3s ease;
    }
    #folder-icon:hover {
      background-color: rgba(255,255,255,0.1);
    }
    #user-input {
      flex-grow: 1;
      padding: 12px;
      border: 1px solid #171717;
      border-radius: 25px;
      margin-right: 10px;
      font-size: 16px;
      background: #1d1d1d;
      color: #fff;
    }
    #user-input::placeholder {
      color: #aaa;
    }
    #user-input:focus {
      border-color: #111;
      outline: none;
    }
    #send-button {
      padding: 15px 20px;
      border: none;
      border-radius: 25px;
      background: #1d1d1d;
      color: #fff;
      cursor: pointer;
      font-size: 16px;
    }
    #send-button i {
      transition: color 0.3s ease-in-out;
    }
    pre {
      position: relative;
      background: #111;
      border-radius: 12px;
      padding: 12px;
      margin: 8px 0;
      overflow-x: auto;
      max-width: 100%;
    }
    pre code {
      font-size: 14px;
    }
    .copy-button {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #1a1a1a;
      color: #ccc;
      border: none;
      border-radius: 8px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      opacity: 0.6;
    }
    .copy-button:hover {
      opacity: 1;
      background: #222;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      overflow: auto;
    }
    .modal-content {
      background: #111;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #242424;
      width: 500px;
      border-radius: 12px;
      position: relative;
    }
    .modal-content input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #222;
      border-radius: 12px;
      background: #222;
      color: #fff;
    }
    .modal-content input::placeholder {
      color: #fff;
    }
    .modal-content button {
      width: 100%;
      padding: 10px;
      background: #212121;
      border: none;
      border-radius: 12px;
      color: #fff;
      cursor: pointer;
    }
    .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
    }
    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus,
    textarea:-webkit-autofill,
    textarea:-webkit-autofill:hover,
    textarea:-webkit-autofill:focus,
    select:-webkit-autofill,
    select:-webkit-autofill:hover,
    select:-webkit-autofill:focus {
      background: #222 !important;
      color: #fff !important;
      -webkit-box-shadow: 0 0 0px 1000px #222 inset !important;
      transition: background-color 5000s ease-in-out 0s;
    }
    #image-preview-container {
      margin-bottom: 10px;
    }
    .image-preview {
      position: relative;
      display: inline-block;
    }
    .image-preview img {
      max-width: 100px;
      max-height: 100px;
      border-radius: 8px;
    }
    .remove-image {
      position: absolute;
      top: 2px;
      right: 2px;
      background: gray;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    .remove-image:hover {
      background: red;
    }
  </style>
</head>
<body>
  <div id="main-container">
    <!-- Sidebar -->
    <div id="sidebar">
      <div id="brand-name">OmniChat</div>
      <button id="new-chat-button">
        <i class="fas fa-plus"></i> New Chat
      </button>
      <button id="upgrade-sidebar-btn" style="display: none;">
        <i class="fas fa-bolt"></i> Upgrade
      </button>
      <div id="chat-list"></div>
    </div>
    <!-- Chat Area -->
    <div id="chat-area">
      <div id="header">
        <div id="message-caps-info">3 messages left until 6:35 PM</div>
        <div id="auth-buttons" style="display: inline-block;">
          <button id="login-btn">Login</button>
          <button id="register-btn">Create Account</button>
        </div>
        <button id="settings-btn" style="display: none;">Settings</button>
      </div>
      <div id="chat-container">
        <div id="chat-display"><div class="message ai-message" style="opacity: 1;">Welcome! How can I help you today?</div></div>
        <!-- Input Area with Image Preview -->
        <div id="input-area">
          <div id="image-preview-container"></div>
          <div id="control-row">
            <i id="folder-icon" class="fas fa-plus"></i>
            <input type="text" id="user-input" placeholder="Message Omni" autocomplete="off" autofocus="">
            <button id="send-button"><i class="fas fa-arrow-up" style="color: gray;"></i></button>
          </div>
          <!-- Hidden file input for image uploads -->
          <input type="file" id="image-input" accept="image/*" style="display:none;">
        </div>
      </div>
    </div>
  </div>
  <!-- Modals -->
  <div id="register-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close" id="register-close">×</span>
      <h2>Create Account</h2>
      <form id="register-form">
        <input type="email" id="register-email" placeholder="Email" required="" autocomplete="email">
        <input type="password" id="register-password" placeholder="Password (min 3 characters)" autocomplete="current-password" required="" minlength="3">
        <button type="submit">Register</button>
      </form>
    </div>
  </div>
  <div id="login-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close" id="login-close">×</span>
      <h2>Login</h2>
      <form id="login-form">
        <input type="email" id="login-email" placeholder="Email" required="" autocomplete="email">
        <input type="password" id="login-password" placeholder="Password" required="" autocomplete="current-password">
        <button type="submit">Login</button>
      </form>
    </div>
  </div>
  <div id="settings-modal" class="modal">
    <div class="modal-content">
      <span class="close" id="settings-close">×</span>
      <h2>Settings</h2>
      <button id="logout-btn">Logout</button>
    </div>
  </div>
  <div id="upgrade-modal" class="modal">
    <div class="modal-content">
      <span class="close" id="upgrade-close">×</span>
      <div style="text-align: center;">
        <i class="fas fa-cloud" style="font-size: 40px; margin-bottom: 10px;"></i>
        <h2>Get access to media files</h2>
        <p style="color: white;">Upgrading to OmniChat Premium will grant you access to unlimited file attachments, with 5x usage limits</p>
        <button id="upgrade-btn">Upgrade</button>
      </div>
    </div>
  </div>
  <!-- External Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
  <script>
    /***************************************
     *        Client-Side JS Logic         *
     ***************************************/
    
    let userMode = "";
    let attachedImage = null;
    const chatDisplay = document.getElementById("chat-display");
    const userInput = document.getElementById("user-input");
    const sendButton = document.getElementById("send-button");
    const newChatButton = document.getElementById("new-chat-button");
    const upgradeSidebarBtn = document.getElementById("upgrade-sidebar-btn");
    const chatList = document.getElementById("chat-list");
    const messageCapsInfo = document.getElementById("message-caps-info");
    const authButtons = document.getElementById("auth-buttons");
    const settingsBtn = document.getElementById("settings-btn");
    const folderIcon = document.getElementById("folder-icon");
    const imageInput = document.getElementById("image-input");
    const imagePreviewContainer = document.getElementById("image-preview-container");
    const registerModal = document.getElementById("register-modal");
    const loginModal = document.getElementById("login-modal");
    const settingsModal = document.getElementById("settings-modal");
    const upgradeModal = document.getElementById("upgrade-modal");
    const registerBtn = document.getElementById("register-btn");
    const loginBtn = document.getElementById("login-btn");
    const registerClose = document.getElementById("register-close");
    const loginClose = document.getElementById("login-close");
    const settingsClose = document.getElementById("settings-close");
    const upgradeClose = document.getElementById("upgrade-close");
    const registerForm = document.getElementById("register-form");
    const loginForm = document.getElementById("login-form");
    const logoutBtn = document.getElementById("logout-btn");
    const upgradeModalBtn = document.getElementById("upgrade-btn");

    // Define showUpgradeModal to fix the ReferenceError
    function showUpgradeModal() {
      upgradeModal.style.display = "block";
    }

    // Set up Marked (with highlight.js)
    marked.setOptions({
      highlight: function (code, lang) {
        if (lang && hljs.getLanguage(lang)) {
          return hljs.highlight(code, { language: lang }).value;
        }
        return hljs.highlightAuto(code).value;
      },
      breaks: true,
      gfm: true,
    });

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Send Message Function
    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message && !attachedImage) return;
      const imageFile = attachedImage;
      addUserMessage(message, imageFile);
      userInput.value = "";
      sendButton.querySelector("i").style.color = "gray";
      userInput.focus();
      imagePreviewContainer.innerHTML = "";
      attachedImage = null;
      try {
        let response;
        if (imageFile) {
          const formData = new FormData();
          formData.append("message", message);
          formData.append("image", imageFile);
          response = await fetch("/stream-chat", { method: "POST", body: formData });
        } else {
          response = await fetch("/stream-chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message })
          });
        }
        const data = await response.json();
        if (data.response) {
          addAiMessage(data.response);
        } else {
          addAiMessage("No response from Gemini API");
        }
        chatDisplay.scrollTo({ top: chatDisplay.scrollHeight, behavior: "smooth" });
      } catch (error) {
        addAiMessage("Error connecting to Gemini API.");
      }
    }

    // Add Message to Chat Display
    function processUserMessage(message) {
      return message
        .replace(/\*\*(.*?)\*\*/g, "<b>$1</b>")
        .replace(/\n/g, "<br>");
    }
    function processAiMessage(message) {
      return marked.parse(message);
    }
    function addUserMessage(message, imageFile) {
      const messageDiv = document.createElement("div");
      messageDiv.classList.add("message", "user-message");
      if (imageFile) {
        const img = document.createElement("img");
        img.style.maxWidth = "200px";
        img.style.borderRadius = "8px";
        const reader = new FileReader();
        reader.onload = function(e) {
          img.src = e.target.result;
        };
        reader.readAsDataURL(imageFile);
        messageDiv.appendChild(img);
      }
      const textDiv = document.createElement("div");
      textDiv.innerHTML = processUserMessage(message);
      messageDiv.appendChild(textDiv);
      chatDisplay.appendChild(messageDiv);
    }
    function addAiMessage(message) {
      const messageDiv = document.createElement("div");
      messageDiv.classList.add("message", "ai-message");
      messageDiv.innerHTML = processAiMessage(message);
      messageDiv.style.opacity = 1;
      chatDisplay.appendChild(messageDiv);
      addCopyButtonsToCodeBlocks();
    }
    function addCopyButtonsToCodeBlocks() {
      document.querySelectorAll("pre code").forEach((codeBlock) => {
        if (!codeBlock.parentNode.querySelector(".copy-button")) {
          const button = document.createElement("button");
          button.className = "copy-button";
          button.textContent = "Copy";
          button.addEventListener("click", () => {
            navigator.clipboard.writeText(codeBlock.textContent)
              .then(() => {
                button.textContent = "Copied!";
                setTimeout(() => {
                  button.textContent = "Copy";
                }, 2000);
              })
              .catch((err) => {
                console.error("Failed to copy: ", err);
                button.textContent = "Error";
                setTimeout(() => {
                  button.textContent = "Copy";
                }, 2000);
              });
          });
          codeBlock.parentNode.appendChild(button);
        }
      });
    }

    // Event Listeners
    sendButton.addEventListener("click", sendMessage);
    userInput.addEventListener("keypress", function(event) {
      if (event.key === "Enter") sendMessage();
    });
    userInput.addEventListener("input", function() {
      const icon = sendButton.querySelector("i");
      icon.style.color = userInput.value.trim() === "" ? "gray" : "#fff";
    });
    newChatButton.addEventListener("click", function() {
      fetch("/new-chat", { method: "POST" })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            chatDisplay.innerHTML = '<div class="message ai-message" style="opacity: 1;">Welcome! How can I help you today?</div>';
            loadChatHistory();
            chatDisplay.scrollTo({ top: chatDisplay.scrollHeight, behavior: "smooth" });
          }
        })
        .catch((err) => console.error(err));
    });
    // Updated Folder Icon: Different popups based on user mode
    folderIcon.addEventListener("click", function() {
      if (userMode === "premium") {
        imageInput.click();
      } else if (userMode === "standard") {
        showUpgradeModal();
      } else {
        registerModal.style.display = "block";
      }
    });
    upgradeSidebarBtn.addEventListener("click", showUpgradeModal);
    registerBtn.addEventListener("click", () => {
      registerModal.style.display = "block";
    });
    loginBtn.addEventListener("click", () => {
      loginModal.style.display = "block";
    });
    registerClose.addEventListener("click", () => {
      registerModal.style.display = "none";
    });
    loginClose.addEventListener("click", () => {
      loginModal.style.display = "none";
    });
    settingsBtn.addEventListener("click", () => {
      settingsModal.style.display = "block";
    });
    settingsClose.addEventListener("click", () => {
      settingsModal.style.display = "none";
    });
    upgradeClose.addEventListener("click", () => {
      upgradeModal.style.display = "none";
    });
    window.addEventListener("click", (event) => {
      if ([registerModal, loginModal, settingsModal, upgradeModal].includes(event.target)) {
        event.target.style.display = "none";
      }
    });

    // Registration Form
    registerForm.addEventListener("submit", function(event) {
      event.preventDefault();
      const email = document.getElementById("register-email").value;
      const password = document.getElementById("register-password").value;
      fetch("/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password }),
      })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          registerModal.style.display = "none";
          // Refresh page after account creation
          location.reload();
        } else {
          alert(data.error || "Registration failed");
        }
      })
      .catch((err) => console.error(err));
    });

    // Login Form
    loginForm.addEventListener("submit", function(event) {
      event.preventDefault();
      const email = document.getElementById("login-email").value;
      const password = document.getElementById("login-password").value;
      fetch("/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password }),
      })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          loginModal.style.display = "none";
          // Refresh page after login
          location.reload();
        } else {
          alert(data.error || "Login failed");
        }
      })
      .catch((err) => console.error(err));
    });

    // Logout Button
    logoutBtn.addEventListener("click", function() {
      fetch("/logout")
        .then((response) => response.json())
        .then((data) => {
          if (data.success) location.reload();
        })
        .catch((err) => console.error(err));
    });

    // Upgrade Modal Button
    upgradeModalBtn.addEventListener("click", function() {
      window.open("http://patreon.com/SkipSchool", "_blank");
      upgradeModal.style.display = "none";
    });

    // Image Input Change (click-based uploads)
    imageInput.addEventListener("change", function() {
      if (this.files && this.files[0]) {
        attachedImage = this.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
          const previewDiv = document.createElement("div");
          previewDiv.className = "image-preview";
          const img = document.createElement("img");
          img.src = e.target.result;
          previewDiv.appendChild(img);
          const removeBtn = document.createElement("button");
          removeBtn.className = "remove-image";
          removeBtn.innerText = "×";
          removeBtn.addEventListener("mouseover", function() {
            removeBtn.style.backgroundColor = "red";
          });
          removeBtn.addEventListener("mouseout", function() {
            removeBtn.style.backgroundColor = "gray";
          });
          removeBtn.addEventListener("click", function() {
            attachedImage = null;
            imagePreviewContainer.innerHTML = "";
            imageInput.value = "";
          });
          previewDiv.appendChild(removeBtn);
          imagePreviewContainer.innerHTML = "";
          imagePreviewContainer.appendChild(previewDiv);
        };
        reader.readAsDataURL(this.files[0]);
      }
    });

    // Global Clipboard Paste Handler for Images
    document.addEventListener("paste", function(e) {
      const clipboardItems = (e.clipboardData || e.originalEvent.clipboardData).items;
      let blob = null;
      for (let i = 0; i < clipboardItems.length; i++) {
        if (clipboardItems[i].type.indexOf("image") === 0) {
          blob = clipboardItems[i].getAsFile();
          break;
        }
      }
      if (blob) {
        if (userMode === "premium") {
          // Premium users: Accept pasted image
          attachedImage = blob;
          const reader = new FileReader();
          reader.onload = function(e) {
            const previewDiv = document.createElement("div");
            previewDiv.className = "image-preview";
            const img = document.createElement("img");
            img.src = e.target.result;
            previewDiv.appendChild(img);
            const removeBtn = document.createElement("button");
            removeBtn.className = "remove-image";
            removeBtn.innerText = "×";
            removeBtn.addEventListener("mouseover", function() {
              removeBtn.style.backgroundColor = "red";
            });
            removeBtn.addEventListener("mouseout", function() {
              removeBtn.style.backgroundColor = "gray";
            });
            removeBtn.addEventListener("click", function() {
              attachedImage = null;
              imagePreviewContainer.innerHTML = "";
            });
            previewDiv.appendChild(removeBtn);
            imagePreviewContainer.innerHTML = "";
            imagePreviewContainer.appendChild(previewDiv);
          };
          reader.readAsDataURL(blob);
        } else if (userMode === "standard") {
          // Standard users get an upgrade popup
          showUpgradeModal();
        } else {
          // Guests: Prompt to create an account
          registerModal.style.display = "block";
        }
      }
    });

    // Update Mode and UI Info
    function updateModeInfo() {
      fetch("/session-info")
        .then((response) => response.json())
        .then((data) => {
          userMode = data.mode;
          messageCapsInfo.textContent = data.messageCaps;
          if (data.loggedIn) {
            authButtons.style.display = "none";
            settingsBtn.style.display = "inline-block";
          } else {
            authButtons.style.display = "inline-block";
            settingsBtn.style.display = "none";
          }
          upgradeSidebarBtn.style.display = data.mode === "standard" ? "block" : "none";
        })
        .catch((err) => console.error(err));
    }
    updateModeInfo();

    // Load Chat History
    function loadChatHistory() {
      fetch("/chat-history")
        .then((response) => response.json())
        .then((data) => {
          if (data.chatHistory) {
            chatList.innerHTML = "";
            const sortedChats = data.chatHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const now = new Date();
            let lastGroup = "";
            sortedChats.forEach((chat) => {
              const chatDate = new Date(chat.timestamp);
              let groupLabel = "";
              if (chatDate.toDateString() === now.toDateString()) groupLabel = "Today";
              else {
                const diffInDays = (now - chatDate) / (1000 * 60 * 60 * 24);
                if (diffInDays < 7) groupLabel = "Last Week";
                else if (diffInDays >= 30) groupLabel = "Long Ago";
                else groupLabel = "Earlier";
              }
              if (groupLabel !== lastGroup) {
                const separator = document.createElement("div");
                separator.style.color = "gray";
                separator.style.margin = "10px 0";
                separator.textContent = groupLabel;
                chatList.appendChild(separator);
                lastGroup = groupLabel;
              }
              const chatItem = document.createElement("div");
              chatItem.classList.add("chat-item");
              const date = chatDate;
              let hours = date.getHours();
              const minutes = date.getMinutes().toString().padStart(2, "0");
              const ampm = hours >= 12 ? "PM" : "AM";
              hours = hours % 12 || 12;
              const formattedTime = hours + ":" + minutes + " " + ampm;
              const formattedDate = (date.getMonth() + 1) + "/" + date.getDate() + "/" + date.getFullYear();
              chatItem.textContent = formattedTime + ", " + formattedDate;
              chatItem.addEventListener("click", () => {
                chatDisplay.innerHTML = "";
                chat.messages.forEach((msg) => {
                  const div = document.createElement("div");
                  div.classList.add("message", msg.role === "user" ? "user-message" : "ai-message");
                  div.innerHTML = msg.role === "user" ? processUserMessage(msg.content) : processAiMessage(msg.content);
                  if (msg.role !== "user") div.style.opacity = 1;
                  chatDisplay.appendChild(div);
                });
                chatDisplay.scrollTo({ top: chatDisplay.scrollHeight, behavior: "smooth" });
              });
              chatList.appendChild(chatItem);
            });
          }
        })
        .catch((err) => console.error(err));
    }
    loadChatHistory();

    // Global Keydown: Auto-focus input if not focused and no modals are open
    document.addEventListener("keydown", (e) => {
      const modals = [registerModal, loginModal, settingsModal, upgradeModal];
      if (modals.some(modal => modal.style.display === "block")) return;
      if (document.activeElement !== userInput && !e.ctrlKey && !e.metaKey && !e.altKey) {
        userInput.focus();
        if (e.key.length === 1) {
          userInput.value += e.key;
          e.preventDefault();
        }
      }
    });
  </script>


</body></html>
